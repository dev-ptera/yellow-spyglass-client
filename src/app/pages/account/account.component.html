<ng-template #desktopMonKey>
    <img
        *ngIf="!vp.sm"
        [src]="apiService.createMonKeyUrl(address)"
        loading="lazy"
        style="min-width: 200px; height: 200px; margin-top: -12px; margin-right: 16px"
    />
</ng-template>

<ng-template #mobileMonKey>
    <img
        *ngIf="vp.sm"
        [src]="apiService.createMonKeyUrl(address)"
        loading="lazy"
        style="width: 120px; height: 120px; min-width: 120px; margin-right: 16px"
    />
</ng-template>

<ng-template #headerContent>
    <mat-card class="account-header divider-border mat-elevation-z0" responsive>
        <!-- Loading -->
        <div *ngIf="!accountOverview" style="display: flex">
            <ng-template [ngTemplateOutlet]="desktopMonKey"></ng-template>
            <div>
                <div class="app-page-title">Loading</div>
                <div
                    class="app-page-subtitle"
                    style="word-break: break-all"
                    [innerHTML]="formatAccountAddress(address)"
                ></div>
            </div>
        </div>

        <!-- Not Loading -->
        <div *ngIf="accountOverview" style="display: flex">
            <ng-template [ngTemplateOutlet]="desktopMonKey"></ng-template>
            <div style="display: flex; flex-direction: column">
                <!-- First Line -->
                <div class="app-page-title" style="margin-bottom: 4px">
                    <ng-container *ngIf="!isRepresentative()">
                        <span *ngIf="accountOverview.opened"> Account </span>
                        <span *ngIf="!accountOverview.opened"> Unopened Account </span>
                    </ng-container>
                    <div *ngIf="isRepresentative()" style="display: flex; align-items: center">
                        <div style="margin-right: 16px">
                            {{
                                accountOverview.principal
                                    ? vp.sm
                                        ? 'Principal Rep'
                                        : 'Principal Representative'
                                    : 'Representative'
                            }}
                        </div>

                        <mat-icon
                            color="primary"
                            *ngIf="onlineRepService.onlineReps.has(address)"
                            matTooltipPosition="right"
                            [matTooltip]="'This representative is online'"
                            >check_circle</mat-icon
                        >
                        <mat-icon
                            color="warn"
                            *ngIf="!onlineRepService.onlineReps.has(address)"
                            matTooltipPosition="right"
                            [matTooltip]="'This representative is offline'"
                            >error_outline</mat-icon
                        >
                    </div>
                </div>

                <!-- Second line -->
                <div
                    style="display: flex; align-items: center; word-break: break-all"
                    class="app-page-subtitle"
                    [style.marginBottom.px]="vp.sm ? 8 : 4"
                >
                    <span class="account-address-wrapper">
                        <span [innerHTML]="formatAccountAddress(address)"></span>
                    </span>
                    <div style="display: flex" [style.marginLeft.px]="vp.sm ? 4 : 16">
                        <ng-container *ngIf="!vp.sm && !vp.md">
                            <app-copy-button [data]="address"></app-copy-button>
                            <app-qr-button [address]="address"></app-qr-button>
                            <app-bookmark-button [id]="address"></app-bookmark-button>
                        </ng-container>
                        <app-account-actions-menu
                            *ngIf="vp.sm || vp.md"
                            [data]="address"
                            [(showFilter)]="showFilter"
                            [showFilterActionButton]="showFilterActionButton()"
                            [showCSVExportActionButton]="showCSVExportActionButton()"
                        ></app-account-actions-menu>
                    </div>
                </div>

                <!-- Third Line -->
                <div
                    *ngIf="accountOverview.opened"
                    class="text-secondary"
                    style="display: flex; align-items: center; flex-wrap: wrap"
                    [style.fontSize.px]="vp.sm ? 16 : 16"
                    [style.marginBottom.px]="vp.sm ? 8 : 24"
                >
                    <div *ngIf="hasAlias(address)" style="display: flex">
                        <ng-container *ngIf="vp.sm"> A.K.A </ng-container>
                        <ng-container *ngIf="!vp.sm"> Also known as </ng-container>
                        {{ getAlias(address) }}
                        <span style="margin: 0 8px">|</span>
                    </div>
                    <div style="display: flex; align-items: center">
                        <div
                            *ngIf="accountOverview.representative === address"
                            class="mat-overline"
                            style="line-height: unset"
                            [style.marginTop.px]="2"
                            [style.fontSize.px]="12"
                        >
                            Self-Represented
                        </div>
                        <div
                            *ngIf="accountOverview.representative !== address"
                            style="display: flex; align-items: center"
                        >
                            Represented by&nbsp;
                            <a
                                class="link text-secondary"
                                [routerLink]="'/' + navItems.account.route + '/' + accountOverview.representative"
                            >
                                {{ accountRepresentative }}
                            </a>
                            <mat-icon
                                *ngIf="!onlineRepService.onlineReps.has(accountOverview.representative)"
                                [matTooltip]="'Account\'s representative is offline'"
                                [matTooltipPosition]="'right'"
                                color="warn"
                                style="height: 16px; width: 16px; font-size: 16px; margin-left: 8px"
                            >
                                error_outline
                            </mat-icon>
                        </div>
                    </div>
                </div>

                <!-- Opened Account Price Data -->
                <div class="account-summary-tags" responsive *ngIf="accountOverview.opened">
                    <ng-template [ngTemplateOutlet]="mobileMonKey"></ng-template>
                    <div class="account-balance" [style.marginTop.px]="vp.sm ? 16 : 0" responsive>
                        <ng-container *ngIf="vp.sm">
                            <div class="account-ban-amount">{{ confirmedBalance }} BAN</div>
                            <div class="text-secondary">
                                <span class="account-btc-amount" [style.marginRight.px]="4">{{
                                    formatBtcPrice(accountOverview.balanceRaw)
                                }}</span>
                                |
                                <span class="account-usd-amount" [style.marginLeft.px]="4">{{
                                    formatUsdPrice(accountOverview.balanceRaw) | currency
                                }}</span>
                            </div>
                        </ng-container>

                        <div *ngIf="!vp.sm" style="display: flex; align-items: center">
                            <span class="account-ban-amount" [style.marginRight.px]="8">
                                {{ confirmedBalance }} BAN
                            </span>
                            路
                            <span class="account-btc-amount text-secondary" style="margin: 0 8px">
                                {{ formatBtcPrice(accountOverview.balanceRaw) }}</span
                            >
                            路
                            <span class="account-usd-amount text-secondary" [style.marginLeft.px]="8">
                                {{ formatUsdPrice(accountOverview.balanceRaw) | currency }}
                            </span>
                        </div>
                    </div>
                </div>

                <!-- Unopened Account Price Data -->
                <div
                    class="account-summary-tags"
                    responsive
                    *ngIf="!accountOverview.opened && getReceivableTransactionsCount() !== 0"
                >
                    <ng-template [ngTemplateOutlet]="mobileMonKey"></ng-template>
                    <div class="account-balance" [style.marginTop.px]="vp.sm ? 16 : 16" responsive>
                        <ng-container *ngIf="vp.sm">
                            <div class="account-ban-amount">
                                {{ withCommas(accountOverview.receivable) }} Receivable BAN
                            </div>
                            <div class="text-secondary">
                                <span class="account-btc-amount" [style.marginRight.px]="4">{{
                                    formatBtcPrice(accountOverview.receivableRaw)
                                }}</span>
                                |
                                <span class="account-usd-amount" [style.marginLeft.px]="4">{{
                                    formatUsdPrice(accountOverview.receivableRaw) | currency
                                }}</span>
                            </div>
                        </ng-container>

                        <div *ngIf="!vp.sm" style="display: flex; align-items: center">
                            <span class="account-ban-amount" [style.marginRight.px]="8">
                                {{ withCommas(accountOverview.receivable) }} Receivable BAN
                            </span>
                            路
                            <span class="account-btc-amount text-secondary" style="margin: 0 8px">
                                {{ formatBtcPrice(accountOverview.receivableRaw) }}</span
                            >
                            路
                            <span class="account-usd-amount text-secondary" [style.marginLeft.px]="8">
                                {{ formatUsdPrice(accountOverview.receivableRaw) | currency }}
                            </span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </mat-card>
</ng-template>

<ng-template #bodyContent>
    <div class="account-tabs-container" responsive>
        <div class="tab-buttons" responsive>
            <button
                blui-inline
                mat-flat-button
                (click)="shownTabNumber = 1"
                [class.active]="shownTabNumber === 1"
                style="border-top-left-radius: 16px; border-right: 0"
            >
                <mat-icon style="margin-right: 8px">verified</mat-icon>
                <span>Transactions</span>
                <span [style.marginLeft.px]="vp.sm ? 0 : 4">({{ accountOverview.blockCount | appComma }})</span>
            </button>

            <button
                blui-inline
                mat-flat-button
                (click)="shownTabNumber = 3"
                [class.active]="shownTabNumber === 3"
                style="border-right: 0"
                *ngIf="delegatorCount > 0"
            >
                <mat-icon style="margin-right: 8px">how_to_vote</mat-icon>
                <span>Delegators</span>
            </button>

            <button
                blui-inline
                mat-flat-button
                (click)="shownTabNumber = 4"
                [class.active]="shownTabNumber === 4"
                style="border-top-right-radius: 16px"
            >
                <mat-icon style="margin-right: 8px">insights</mat-icon>
                <span>Insights</span>
            </button>

            <!--
            <button
                mat-flat-button
                (click)="shownTabNumber = 5; fetchNfts()"
                [class.active]="shownTabNumber === 5"
                style="border-top-right-radius: 4px"
            >
                <ng-container *ngIf="vp.sm">
                    <mat-icon>image</mat-icon>
                </ng-container>
                <ng-container *ngIf="!vp.sm"> NFTs </ng-container>
            </button>
            -->
        </div>

        <div
            responsive
            class="tx-content-container divider-border"
            style="border-top-left-radius: 0"
            [style.backgroundColor]="
                shownTabNumber === 4 || shownTabNumber === 5 || shownTabNumber === 1 ? 'unset' : ''
            "
            [class.divider-border]="shownTabNumber !== 4 && shownTabNumber !== 5 && shownTabNumber !== 1"
        >
            <ng-container *ngIf="shownTabNumber === 1">
                <mat-accordion
                    *ngIf="getReceivableTransactionsCount() > 0"
                    style="
                        display: flex;
                        width: 100%;
                        padding: 0;
                        margin-bottom: 16px;
                        border-radius: 16px;
                        overflow: hidden;
                        border-top-left-radius: 0;
                    "
                    class="divider-border"
                >
                    <mat-expansion-panel style="width: 100%" [expanded]="true">
                        <mat-expansion-panel-header style="height: 56px">
                            <mat-panel-title style="font-weight: 400">
                                <span [style.fontSize.px]="vp.sm ? 14 : 16">
                                    {{ getReceivableTransactionsCount() | appComma }}
                                </span>
                                <span
                                    [style.fontSize.px]="vp.sm ? 14 : 16"
                                    style="margin-left: 8px"
                                    class="text-secondary"
                                >
                                    Receivable Transactions
                                </span>
                            </mat-panel-title>
                        </mat-expansion-panel-header>
                        <account-tx-tab [address]="address" [isPending]="true"></account-tx-tab>
                    </mat-expansion-panel>
                </mat-accordion>

                <mat-card
                    style="padding: 0"
                    class="divider-border"
                    [style.borderTopLeftRadius.px]="getReceivableTransactionsCount() > 0 ? 16 : 0"
                >
                    <ng-container>
                        <div
                            style="
                                padding: 16px 8px 16px 28px;
                                display: flex;
                                justify-content: space-between;
                                align-items: center;
                            "
                        >
                            <div>
                                <span [style.fontSize.px]="vp.sm ? 14 : 16">{{
                                    accountOverview.blockCount | appComma
                                }}</span>
                                <span
                                    [style.fontSize.px]="vp.sm ? 14 : 16"
                                    style="margin-left: 8px"
                                    class="text-secondary"
                                >
                                    Confirmed Transactions
                                </span>
                            </div>
                            <div style="display: flex; justify-content: center; align-items: center">
                                <app-csv-button
                                    *ngIf="showCSVExportActionButton()"
                                    [address]="address"
                                ></app-csv-button>
                                <app-filter-button
                                    *ngIf="showFilterActionButton()"
                                    style="margin-left: 8px"
                                    [(showFilter)]="showFilter"
                                ></app-filter-button>
                            </div>
                        </div>
                        <mat-divider></mat-divider>
                    </ng-container>
                    <account-tx-tab
                        style="margin-top: 8px"
                        [address]="address"
                        [blockCount]="accountOverview.blockCount"
                    ></account-tx-tab>
                </mat-card>
            </ng-container>

            <account-delegators-tab *ngIf="shownTabNumber === 3" [address]="address"></account-delegators-tab>

            <account-insights-tab
                *ngIf="shownTabNumber === 4"
                [address]="address"
                [maxInsightsLimit]="MAX_INSIGHTS"
                [blockCount]="accountOverview.blockCount"
            >
            </account-insights-tab>

            <!--
            <account-nfts-tab
                *ngIf="shownTabNumber === 5"
                [address]="address"
                [nfts]="nfts"
                [isLoadingNFTs]="isLoadingNFTs"
                [hasError]="hasNFTsError"
            >
            </account-nfts-tab>
            -->
        </div>
    </div>
</ng-template>

<mat-sidenav-container
    [hasBackdrop]="vp.sm || vp.md"
    (backdropClick)="showFilter = false"
    style="z-index: 4"
    style="width: 100%"
>
    <mat-sidenav
        [mode]="vp.md || vp.sm ? 'over' : 'side'"
        class="filter-drawer"
        (opened)="disableBodyScrollWhenOpen()"
        (closed)="disableBodyScrollWhenOpen()"
        [opened]="showFilter"
        position="end"
        [disableClose]="true"
    >
        <app-transaction-filter-drawer
            *ngIf="accountOverview"
            (close)="showFilter = false"
            (search)="vp.md || vp.sm ? (showFilter = false) : undefined"
            [defaultPageSize]="isBRPD ? DEFAULT_BRPD_TX_SIZE : DEFAULT_TX_SIZE"
        ></app-transaction-filter-drawer>
    </mat-sidenav>
    <mat-sidenav-content style="height: 100vh">
        <div class="app-page-root" responsive style="height: unset">
            <div class="app-page-content" style="max-width: 1100px">
                <ng-template [ngTemplateOutlet]="headerContent"></ng-template>
                <div *ngIf="accountOverview" class="animation-body">
                    <ng-template [ngTemplateOutlet]="bodyContent"></ng-template>
                </div>
                <ng-container *ngIf="hasError">
                    <mat-divider></mat-divider>
                    <app-error></app-error>
                </ng-container>
            </div>
        </div>
    </mat-sidenav-content>
</mat-sidenav-container>
